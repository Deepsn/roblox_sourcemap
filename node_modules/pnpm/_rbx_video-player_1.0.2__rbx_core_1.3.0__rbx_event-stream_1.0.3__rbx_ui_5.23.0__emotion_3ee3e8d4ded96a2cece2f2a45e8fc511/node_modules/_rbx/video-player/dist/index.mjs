import e,{useState as t,useEffect as n,useMemo as r,useRef as o,useCallback as i,forwardRef as a,useImperativeHandle as u}from"react";import{makeStyles as s,Slider as c,IconButton as l,PauseIcon as d,PlayArrowIcon as f,VolumeOffRoundedIcon as v,VolumeUpRoundedIcon as p,FullscreenExitIcon as m,FullscreenIcon as h,Video as g}from"@rbx/ui";import{Configuration as b,Tracker as y}from"@rbx/event-stream";import{uuidService as E}from"@rbx/core";var S=function(){return S=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},S.apply(this,arguments)};function w(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function T(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,u)}s((r=r.apply(e,t||[])).next())})}function x(e,t){var n,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=u(0),a.throw=u(1),a.return=u(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(s){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,r=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}"function"==typeof SuppressedError&&SuppressedError;var A,L,P,M,C=s()(function(){return{container:{position:"relative"}}}),I=s()(function(e){return{controls:{position:"absolute",bottom:0,left:0,width:"100%",height:"100%",zIndex:10},controlsWrapper:{height:"100%",width:"100%",display:"flex",flexDirection:"column",justifyContent:"end",background:"linear-gradient(transparent 0%, transparent 80%, rgba(0, 0, 0, 0.3) 90%, rgba(0, 0, 0, 0.6) 100%)"},controlsFooter:{display:"flex",flexDirection:"column",justifyContent:"end",padding:e.spacing(1,2.5),"& .MuiSlider-root":{color:e.palette.content.static.light},"& .MuiSlider-thumb":{backgroundColor:e.palette.content.static.light},"& .MuiSlider-track":{backgroundColor:e.palette.content.static.light},"& .MuiSlider-rail":{backgroundColor:e.palette.content.static.light},"&.noTransitions":{"& .MuiSlider-thumb":{transition:"none !important"},"& .MuiSlider-track":{transition:"none !important"}}},controlsRow:{display:"flex",alignItems:"center",justifyContent:"space-between"},rightControls:{display:"flex",alignItems:"center",marginLeft:"auto",gap:e.spacing(1)},volumeControl:{position:"relative",display:"flex",alignItems:"center"},volumeSlider:{width:80,position:"absolute",right:"100%",marginRight:e.spacing(1),opacity:0,visibility:"hidden",transition:"opacity 0.2s, visibility 0.2s","&.expanded":{opacity:1,visibility:"visible"}},overlayButton:{flex:1,outline:"none !important","&:focus":{outline:"none !important",boxShadow:"none !important"},"&:focus-visible":{outline:"none !important"}},mobileControls:{position:"absolute",bottom:0,left:0,width:"100%",height:"100%",zIndex:1e3,pointerEvents:"auto"},noTransitions:{"& .MuiSlider-thumb":{transition:"none !important"},"& .MuiSlider-track":{transition:"none !important"},"& .MuiSlider-rail":{transition:"none !important"},"& *":{transition:"none !important"}}}});!function(e){e.VideoImpression="VIDEO_IMPRESSION",e.VideoAction="VIDEO_ACTION",e.VideoProgress="VIDEO_PROGRESS"}(A||(A={})),function(e){e.Play="play",e.Pause="pause",e.Fullscreen="fullscreen",e.Navigate="navigate",e.Volume="volume",e.Scrub="scrub",e.ExitFullscreen="exit_fullscreen",e.Hover="hover",e.Loop="loop",e.Load="load",e.Complete="complete",e.End="end"}(L||(L={})),function(e){e.Video="video"}(P||(P={})),function(e){e.VideoEngagementEvent="videoEngagementEventType"}(M||(M={}));var V={error:0,warn:1,info:2,debug:3},k=function(){function e(e){this.config="boolean"==typeof e?{enabled:e,level:"debug",prefix:"[VideoAnalytics]",excludeErrors:!1}:{enabled:e.enabled,level:e.level,prefix:e.prefix||"[VideoAnalytics]",excludeErrors:e.excludeErrors||!1}}return e.prototype.shouldLog=function(e){return!!this.config.enabled&&((!this.config.excludeErrors||"error"!==e)&&V[e]<=V[this.config.level])},e.prototype.formatMessage=function(e,t,n){var r=(new Date).toISOString(),o=e.toUpperCase().padEnd(5),i="".concat(this.config.prefix," [").concat(o,"] ").concat(r," ").concat(t);return void 0!==n?[i,n]:[i]},e.prototype.error=function(e,t){if(this.shouldLog("error")){var n=this.formatMessage("error",e,t);console.error.apply(console,n)}},e.prototype.warn=function(e,t){if(this.shouldLog("warn")){var n=this.formatMessage("warn",e,t);console.warn.apply(console,n)}},e.prototype.info=function(e,t){if(this.shouldLog("info")){var n=this.formatMessage("info",e,t);console.log.apply(console,n)}},e.prototype.log=function(e,t){if(this.shouldLog("debug")){var n=this.formatMessage("debug",e,t);console.log.apply(console,n)}},e}(),O=function(e,r){void 0===r&&(r={});var o=t(!1),i=o[0],a=o[1],u=r.threshold,s=void 0===u?.8:u,c=r.debugLogger,l=r.id;return n(function(){if(e){var t=new IntersectionObserver(function(e){e.forEach(function(e){a(e.isIntersecting),c&&!e.isIntersecting?c.log("".concat(l," is no longer visible")):c&&e.isIntersecting&&c.log("".concat(l," is now visible"))})},{threshold:s});return t.observe(e),function(){t.unobserve(e)}}},[e,s,c,l]),i},D=function(e,t,a,u,s,c,l,d){void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===d&&(d=!1);var f=r(function(){return new k(c)},[c]),v=o(null),p=o(!1),m=o(E.generateRandomUuid()),h=o(E.generateRandomUuid()),g=o(!1),w=o(!1),T=o({startTime:null,isPlaying:!1,scrubStartTime:null,scrubStartPosition:null,playStartTime:null,hasPlayedOneSecond:!1}),x=o(!1);o(!0);var M=o({startTime:null}),C=o(void 0),I=O(s&&t?e.current:null,{threshold:(null==t?void 0:t.visibilityThreshold)||.8,debugLogger:f,id:"VideoPlayer"}),V=O(s&&(null==u?void 0:u.current)||null,{threshold:(null==t?void 0:t.visibilityThreshold)||.8,debugLogger:f,id:"CTAElement"}),D=i(function(n,r,o){var i;if(s&&v.current&&t&&e.current)try{var u=e.current,c=u.duration,l={target:t.target,eventType:"videoEngagementEvent",context:P.Video,localTime:new Date,additionalProperties:S({videoEngagementEventType:n,videoAssetId:t.assetId,sourceId:t.sourceId,source:t.source,impressionId:m.current,playbackSessionId:h.current,videoAssetDuration:c,isVisible:!0,isAudible:!u.muted&&u.volume>0,isFullscreen:a,volumeLevel:u.muted?0:u.volume,autoplayByDefault:u.autoplay,actionType:r},o)};v.current.sendEventViaImg(l),f.log("".concat(n,": ").concat(JSON.stringify(l))),null===(i=t.onSendEvent)||void 0===i||i.call(t,"".concat(n,": ").concat(JSON.stringify(l)))}catch(e){f.error("Failed to send event:",e)}},[s,t,a,f,e]);n(function(){l&&!x.current?(D(A.VideoAction,L.Hover),x.current=!0):x.current=l},[D,l]),n(function(){if(s&&t){if(!g.current)try{var e=function(e){var t,n="production"===(t=e.environment)?"https://ecsv2.roblox.com":"https://ecsv2.".concat(t,".robloxlabs.com");return new b({baseUrl:"".concat(n,"/").concat(e.target)})}(t);v.current=new y(e),g.current=!0,f.log("Event stream tracker initialized:",{analyticsConfig:t,enableAnalytics:s})}catch(e){f.error("Failed to initialize event stream tracker:",e)}}else f.warn("Analytics not enabled, config not provided")},[s,t,f]);var R=i(function(){if(!p.current&&e.current&&t&&I){var n=T.current,r=e.current;(function(e){var t=e.hasPlayedOneSecond,n=e.autoPlayActive,r=e.onHoverActive;return e.meetsCtaCriteria||n&&t||t||r&&t})({hasPlayedOneSecond:n.hasPlayedOneSecond,autoPlayActive:r.autoplay,onHoverActive:l,meetsCtaCriteria:V&&I||d})&&(D(A.VideoImpression),p.current=!0)}},[e,t,D,l,I,V,d]),F=i(function(e,t){D(A.VideoProgress,void 0,{progressStartTime:e,progressEndTime:t})},[D]),N=i(function(){M.current.startTime=Date.now()},[]),B=i(function(){var e=M.current;null!==e.startTime&&(D(A.VideoAction,L.Load,{loadTime:Date.now()-e.startTime}),e.startTime=null)},[D]),U=i(function(e,n){var r,o;if(s&&t){var i=T.current;if(null!==i.playStartTime&&!i.hasPlayedOneSecond)e-i.playStartTime>=(null!==(r=t.impressionPlaybackThreshold)&&void 0!==r?r:1)&&(i.hasPlayedOneSecond=!0,R());if(n>0&&t.completionThreshold&&!w.current)e/n*100>=t.completionThreshold&&(null===(o=t.onComplete)||void 0===o||o.call(t),D(A.VideoAction,L.Complete),w.current=!0)}},[s,t,R,D]),j=i(function(){var t=T.current;if(e.current&&null!==t.startTime){var n=e.current.currentTime;t.isPlaying&&n>t.startTime&&F(t.startTime,n),t.startTime=null}D(A.VideoAction,L.Loop)},[D,e,F]),H=i(function(){var t=T.current;e.current&&(t.startTime=e.current.currentTime,t.isPlaying=!0,t.playStartTime=e.current.currentTime,D(A.VideoAction,L.Play))},[e,D]),W=i(function(){var t=T.current;if(e.current&&null!==t.startTime){var n=e.current.currentTime;t.isPlaying&&n>t.startTime&&F(t.startTime,n),D(A.VideoAction,L.Pause),t.isPlaying=!1,t.startTime=null}},[e,D,F]),X=i(function(e,t){D(A.VideoAction,L.Volume,{volumeLevel:t?0:e})},[D]),$=i(function(t){var n=T.current;n.isPlaying&&null!==n.startTime&&e.current&&(F(n.startTime,t),n.isPlaying=!1),n.scrubStartTime=Date.now(),n.scrubStartPosition=t},[e,F]),z=i(function(t){var n=T.current;if(null!==n.scrubStartTime&&null!==n.scrubStartPosition){var r=n.scrubStartPosition;D(A.VideoAction,L.Scrub,{scrubStartTime:r,scrubEndTime:t}),e.current&&!e.current.paused&&(n.startTime=t,n.isPlaying=!0),n.scrubStartTime=null,n.scrubStartPosition=null}},[e,D]),q=i(function(){D(A.VideoAction,L.Fullscreen)},[D]),G=i(function(){D(A.VideoAction,L.ExitFullscreen)},[D]);n(function(){void 0!==C.current&&C.current!==a&&(a?q():G()),C.current=a},[a,q,G]);var J=i(function(){W(),D(A.VideoAction,L.Navigate,{destination:null==t?void 0:t.navigationDestination})},[D,W,t]),Z=i(function(){var t=T.current;if(e.current&&null!==t.startTime){var n=e.current.currentTime;n>t.startTime&&F(t.startTime,n),D(A.VideoAction,L.End)}},[D,F,e]);n(function(){I&&R()},[I,V,R]);var _=i(function(){e.current&&(Z(),h.current=E.generateRandomUuid(),w.current=!1,T.current={startTime:null,isPlaying:!1,scrubStartTime:null,scrubStartPosition:null,playStartTime:null,hasPlayedOneSecond:!1},M.current={startTime:null},f.log("Video reset: New playback session created"))},[e,f,Z]);return{onPlay:H,onPause:W,onVolumeChange:X,onSeekStart:$,onSeekEnd:z,onFullscreen:q,onExitFullscreen:G,onNavigate:J,onEnd:Z,onLoop:j,onLoadStart:N,onLoadEnd:B,onTimeUpdate:U,resetVideo:_}},R=a(function(a,s){var g,b,y=a.videoElementRef,E=a.disableVolumeSlider,S=a.enableAnalytics,w=void 0!==S&&S,A=a.analyticsConfig,L=a.fullScreenEnabled,P=void 0!==L&&L,M=a.debug,C=void 0!==M&&M,V=a.onHoverActive,R=void 0!==V&&V,F=a.ctaObject,N=a.loop,B=void 0!==N&&N,U=a.hidden,j=void 0!==U&&U,H=a.initialVolume,W=void 0===H?1:H,X=a.isMobileView,$=void 0!==X&&X,z=I(),q=z.classes,G=z.cx,J=o(null),Z=t(!1),_=Z[0],Q=Z[1],K=t(0),Y=K[0],ee=K[1],te=t(1),ne=te[0],re=te[1],oe=t(!1),ie=oe[0],ae=oe[1],ue=t(!1),se=ue[0],ce=ue[1],le=t(!1),de=le[0],fe=le[1],ve=t(0),pe=ve[0],me=ve[1],he=t(!1),ge=he[0],be=he[1],ye=o(!1),Ee=o(!1),Se=o(!1),we=o(!1),Te=o(!0),xe=r(function(){return new k(C)},[C]),Ae=o(null);n(function(){var e=y.current;e&&(ae(e.muted),re(W),e.volume=W)},[y,W]);var Le=O(J.current,{threshold:(null==A?void 0:A.visibilityThreshold)||.8,debugLogger:xe,id:"PlayPauseButton"}),Pe=D(y,A,de,F,w,C,R,Le);u(s,function(){var e=y.current;return e?Object.assign(e,{reset:function(){e.pause(),Pe.resetVideo(),e.currentTime=0,ce(!1),ye.current=!1,Ee.current=!1,Se.current=!1,we.current=!1,xe.log("Video reset: All state and refs have been reset")}}):{}},[y,Pe,xe]);var Me=i(function(){var e=y.current;!e||e.paused||e.ended||(me(e.currentTime),Ae.current=requestAnimationFrame(Me))},[y]),Ce=i(function(){null==Ae.current&&(Ae.current=requestAnimationFrame(Me))},[Me]),Ie=i(function(){null!=Ae.current&&(cancelAnimationFrame(Ae.current),Ae.current=null)},[]);n(function(){return _?Ce():Ie(),Ie},[_,Ce,Ie]);var Ve=i(function(){var e=y.current;e&&(_?e.pause():e.play())},[_,y]),ke=i(function(){var e,t,n;if(y.current)return(null==A?void 0:A.videoClickAction)?(e=A.videoClickAction,t={fullScreenEnabled:P,onFullscreen:Pe.onFullscreen,onExitFullscreen:Pe.onExitFullscreen,onNavigate:Pe.onNavigate},n=t.onNavigate,void("NAVIGATE"===e&&n())):void Ve()},[y,A,P,Pe,Ve]),Oe=i(function(){var e=y.current;e&&Pe.onTimeUpdate(e.currentTime,e.duration)},[y,Pe]),De=i(function(){Pe.onLoadStart()},[Pe]),Re=i(function(){Pe.onLoadEnd()},[Pe]),Fe=i(function(){var e=y.current;e&&(ee(e.duration),me(e.currentTime)),Re()},[y,Re]),Ne=i(function(){_||Pe.onPlay(),Q(!0)},[Pe,_]),Be=i(function(){var e=y.current,t=e&&e.duration>0&&e.duration-e.currentTime<=.1,n=e&&e.duration>0&&e.currentTime/e.duration*100>=100&&!0===B;t&&!n?(be(!0),Q(!1),e.currentTime=0,me(0),setTimeout(function(){return be(!1)},50),Pe.onPause()):n?(Pe.onLoop(),e.currentTime=0,me(0),e.play().catch(function(e){xe.warn("[VideoControlsOverlay] Loop play failed:",e)})):(Q(!1),Pe.onPause())},[y,Pe,B,xe]),Ue=i(function(){Pe.onEnd()},[Pe]),je=i(function(){var e=y.current;if(e){var t=e.volume,n=e.muted;re(t),ae(n),we.current||Te.current||Pe.onVolumeChange(t,n),Te.current&&(Te.current=!1)}},[Pe,y]);n(function(){var e=y.current;if(e)return e.addEventListener("volumechange",je),e.addEventListener("beforeunload",Ue),e.addEventListener("timeupdate",Oe),e.addEventListener("loadedmetadata",Fe),e.addEventListener("play",Ne),e.addEventListener("pause",Be),e.addEventListener("loadstart",De),function(){e.removeEventListener("timeupdate",Oe),e.removeEventListener("loadedmetadata",Fe),e.removeEventListener("play",Ne),e.removeEventListener("pause",Be),e.removeEventListener("loadstart",De),e.removeEventListener("beforeunload",Ue),e.removeEventListener("volumechange",je)}},[y,Pe,Oe,Fe,Ne,Be,De,Re,Ue,je]);var He=i(function(){var e=y.current;e&&(ye.current=!0,Ee.current=_,_&&e.pause(),Pe.onSeekStart(e.currentTime))},[y,Pe,_]),We=i(function(){var e=y.current;e&&ye.current&&(ye.current=!1,Pe.onSeekEnd(e.currentTime),Ee.current&&e.play())},[y,Pe]),Xe=i(function(e,t){var n=y.current;if(n){var r=Array.isArray(t)?t[0]:t;n.currentTime=r,me(r)}},[y]),$e=i(function(e,t){if(y.current){var n=y.current,r=Array.isArray(t)?t[0]:t;n.muted=0===r,n.volume=r}},[y]),ze=i(function(e){e.stopPropagation(),we.current=!0},[]),qe=i(function(){we.current&&(we.current=!1,Pe.onVolumeChange(ne,ie))},[Pe,ne,ie]);n(function(){var e=function(){ye.current&&We(),we.current&&qe()};return document.addEventListener("mouseup",e),document.addEventListener("touchend",e),function(){document.removeEventListener("mouseup",e),document.removeEventListener("touchend",e)}},[We,qe]);var Ge=i(function(){var e=y.current;e&&(e.muted=!e.muted)},[y]),Je=i(function(){return T(void 0,void 0,void 0,function(){var e,t;return x(this,function(n){switch(n.label){case 0:if(!(e=y.current))return[2];n.label=1;case 1:return n.trys.push([1,7,,8]),e.requestFullscreen?[4,e.requestFullscreen()]:[3,3];case 2:return n.sent(),[3,6];case 3:return e.webkitRequestFullscreen?[4,e.webkitRequestFullscreen()]:[3,5];case 4:return n.sent(),[3,6];case 5:e.webkitEnterFullscreen&&e.webkitEnterFullscreen(),n.label=6;case 6:return fe(!0),[3,8];case 7:return t=n.sent(),xe.warn("[VideoControlsOverlay] Enter fullscreen failed:",t),[3,8];case 8:return[2]}})})},[y,xe]),Ze=i(function(){return T(void 0,void 0,void 0,function(){var e,t,n;return x(this,function(r){switch(r.label){case 0:e=document,t=y.current,r.label=1;case 1:return r.trys.push([1,7,,8]),document.exitFullscreen?[4,document.exitFullscreen()]:[3,3];case 2:return r.sent(),[3,6];case 3:return e.webkitExitFullscreen?[4,e.webkitExitFullscreen()]:[3,5];case 4:return r.sent(),[3,6];case 5:t&&t.webkitExitFullscreen&&t.webkitExitFullscreen(),r.label=6;case 6:return fe(!1),[3,8];case 7:return n=r.sent(),xe.warn("[VideoControlsOverlay] Exit fullscreen failed:",n),[3,8];case 8:return[2]}})})},[y,xe]),_e=i(function(e){null==e||e.stopPropagation(),P&&(de?Ze():Je())},[P,de,Je,Ze]);n(function(){var e=document,t=y.current,n=function(){var n=Boolean(document.fullscreenElement||e.webkitFullscreenElement||t&&(t.webkitDisplayingFullscreen||"fullscreen"===t.webkitPresentationMode));fe(n)};return document.addEventListener("fullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),t&&(t.addEventListener("webkitbeginfullscreen",n),t.addEventListener("webkitendfullscreen",n)),function(){document.removeEventListener("fullscreenchange",n),document.removeEventListener("webkitfullscreenchange",n),t&&(t.removeEventListener("webkitbeginfullscreen",n),t.removeEventListener("webkitendfullscreen",n))}},[y]);var Qe=i(function(e){" "===e.key&&(e.stopPropagation(),e.preventDefault(),Ve())},[Ve]),Ke=i(function(){return ce(!0)},[]),Ye=i(function(){we.current||ce(!1)},[]);return e.createElement("div",{className:G($&&P?q.mobileControls:q.controls,(g={},g[q.noTransitions]=_||ge,g)),style:{display:j?"none":void 0}},e.createElement("div",{className:q.controlsWrapper},e.createElement("div",{className:q.overlayButton,onClick:ke,onKeyDown:Qe,tabIndex:-1,role:"button","aria-label":_?"Pause video":"Play video"}),e.createElement("div",{className:q.controlsFooter},e.createElement(c,{value:pe,max:Y||100,onChange:Xe,onMouseDown:He,onTouchStart:He,onClick:i(function(e){return e.stopPropagation()},[]),color:"secondary",size:"small",step:1e-6,"aria-label":"Video progress"}),e.createElement("div",{className:q.controlsRow},e.createElement(l,{ref:J,onClick:function(e){e.stopPropagation(),Ve()},color:"onMediaLight",size:"small","aria-label":_?"Pause":"Play"},_?e.createElement(d,null):e.createElement(f,null)),e.createElement("div",{className:q.rightControls},e.createElement("div",{className:q.volumeControl,onMouseEnter:Ke,onMouseLeave:Ye,onClick:i(function(e){return e.stopPropagation()},[])},!E&&e.createElement(c,{className:G((b={},b[q.volumeSlider]=!0,b.expanded=se,b)),value:ie?0:ne,max:1,step:1e-6,onChange:$e,onMouseDown:ze,onTouchStart:ze,color:"secondary",size:"small","aria-label":"Volume"}),e.createElement(l,{onClick:Ge,color:"onMediaLight",size:"small","aria-label":ie?"Unmute":"Mute"},ie?e.createElement(v,null):e.createElement(p,null))),P&&e.createElement(l,{onClick:_e,color:"onMediaLight",size:"small","aria-label":de?"Exit fullscreen":"Enter fullscreen"},de?e.createElement(m,null):e.createElement(h,null)))))))});R.displayName="VideoControlsOverlay";var F=function(e){var t=o(null);return n(function(){e&&("function"==typeof e?e(t.current):e.current=t.current)}),t},N=function(t,n){var r=t.enableAnalytics,o=t.analyticsConfig,i=t.headerContent,a=t.disableControls,u=t.controlsConfig,s=t.debug,c=void 0!==s&&s,l=t.fullscreenActive,d=void 0!==l&&l,f=t.onHoverActive,v=void 0!==f&&f,p=t.ctaObject,m=t.loop,h=void 0!==m&&m,b=w(t,["enableAnalytics","analyticsConfig","headerContent","disableControls","controlsConfig","debug","fullscreenActive","onHoverActive","ctaObject","loop"]),y=F(n),E=C().classes;return e.createElement("div",{className:E.container},e.createElement(g,S({ref:y},b,{controls:!1,headerContent:i})),e.createElement(R,S({ref:n,videoElementRef:y,ctaObject:p,enableAnalytics:r,analyticsConfig:o,debug:c,fullScreenEnabled:d,onHoverActive:v,loop:h,hidden:a},u)))};N.displayName="VideoPlayer";var B=e.forwardRef(N),U=function(e,t){if(!e)return t;try{return JSON.parse(e)}catch(e){return t}},j=function(e){return!function(e){return null==e||""===e}(e)};function H(e,t){for(var n=0;n<e.length;n+=1){var r=e.start(n),o=e.end(n);if(t>=r&&t<o)return{start:r,end:o}}return null}var W=function(e,t){this.name=e,this.value=t},X=function(e,t){this.width=e,this.height=t},$="RESOLUTION",z="AVERAGE-BANDWIDTH",q="BANDWIDTH",G="CODECS",J="FRAME-RATE",Z="NAME",_="QUERYPARAM",Q="VALUE",K="URL",Y="#EXTM3U",ee="#EXTINF",te="#EXT-X-DEFINE",ne="#EXT-X-STREAM-INF",re=function(){function e(e,t,n,r){var o=this;this.duration=function(){return o.durations.reduce(function(e,t){return e+t},0)},this.nextSegmentIdx=function(e){return o.segmentIdxByTime(e)+1},this.segmentUrl=function(e){return new URL(o.segments[e],o.url).toString()},this.url=e,this.segments=t,this.durations=n,this.startTimes=r}return e.prototype.segmentIdxByTime=function(e){var t=function(e,t,n){for(var r=0,o=e.length-1;r<=o;){var i=o+r>>1,a=n(t,e[i]);if(a>0)r=i+1;else{if(!(a<0))return i;o=i-1}}return-r-1}(this.startTimes,e,function(e,t){return e-t});return t<0&&(t=-t-2),t},e.parse=function(t,n){for(var r=this,o=n.split("\n"),i=o.filter(function(e){return e.startsWith(ee)}),a=this.getXDefines(o,t.toString()),u=o.filter(function(e){return!e.startsWith("#")&&""!==e.trim()}).map(function(e){return r.replaceAllDefines(a,e)}),s=i.map(function(e){return parseFloat(e.split(":",2)[1].replace(",",""))}),c=[0],l=0;l<s.length;l+=1){var d=s[l];c.push(c[c.length-1]+d)}return new e(t,u,s,c)},e.getXDefines=function(e,t){var n=this,r=this.parseQueryParams(t);return e.filter(function(e){return e.startsWith(te)}).map(function(e){var t=n.parseAttrsToMap(e);if(t.has(_)){var o=t.get(_)||"",i=String(U(o,o.replace(/^"|"$/g,""))),a=r.get(i)||"";return new W(i,a)}if(t.has(Z)&&t.has(Q)){var u=t.get(Z)||"",s=String(U(u,u.replace(/^"|"$/g,""))),c=t.get(Q)||"",l=String(U(c,c.replace(/^"|"$/g,"")));return new W(s,l)}return new W("","")}).filter(function(e){return null!=e&&j(e.name)})},e.parseAttrsToMap=function(e){var t,n=e.indexOf(":");if(n<0)return new Map;var r=e.substring(n+1),o=new Map,i=null===(t=r.match(/[A-Z-]+=/g))||void 0===t?void 0:t.map(function(e){return e.replace(/=$/,"")}),a=r.split(/[A-Z-]+=/).filter(function(e){return""!==e}).map(function(e){return e.replace(/,$/,"")});if(i&&a)for(var u=0;u<i.length;u+=1)u<a.length&&o.set(i[u],a[u]);return o},e.parseQueryParams=function(e){var t=e.indexOf("?"),n=new Map;if(t<0)return n;for(var r=e.substring(t+1).split("&"),o=0;o<r.length;o+=1){var i=r[o],a=i.indexOf("=");if(a>=1){var u=i.substring(0,a),s=i.substring(a+1);n.set(u,s)}}return n},e.replaceAllDefines=function(e,t){for(var n=t,r=0;r<e.length;r+=1){var o=e[r];n=n.replace("{$".concat(o.name,"}"),o.value)}return n},e.selectHighestResStream=function(e){for(var t=e[0],n=0;n<e.length;n+=1){var r=e[n],o=r.get($),i=t.get($);o.height>i.height&&(t=r)}return t},e.parseMasterManifest=function(e,t){var n=e.split("\n");for(var r,o=this.getXDefines(n,(null==t?void 0:t.toString())||""),i=new Map,a=0;a<o.length;a+=1){var u=o[a];if(i.set(u.name,u.value),"RBX-DURATION"===u.name){var s=parseFloat(u.value);Number.isNaN(s)||(r=s)}}var c=n.filter(function(e){return!e.startsWith("#")}).map(function(e){return e.trim()}).filter(function(e){return j(e)});var l=n.filter(function(e){return e.startsWith(ne)}).map(function(e,t){var n=function(e){var t,n=e.indexOf(":");if(n<0)return[];var r=e.substring(n+1),o=null===(t=r.match(/[A-Z-]+=/g))||void 0===t?void 0:t.map(function(e){return e.replace(/=$/,"")}),i=r.split(/[A-Z-]+=/).filter(function(e){return""!==e}).map(function(e){return e.replace(/,$/,"")});return(null==o?void 0:o.map(function(e,t){return[e,i[t]]}))||[[]]}(e),r=new Map;r.set(K,function(e,t){for(var n=t,r=0;r<e.length;r+=1){var o=e[r];n=n.replace("{$".concat(o.name,"}"),o.value)}return n}(o,c[t]));for(var i=0;i<n.length;i+=1){var a=n[i],u=a[0],s=a[1],l=void 0;if(u===z)l=parseInt(s,10);else if(u===q)l=parseInt(s,10);else if(u===$){var d=s.split("x",2).map(function(e){return parseInt(e,10)});l=new X(d[0],d[1])}else l=u===J?parseFloat(s):s;r.set(u,l)}return r});return{streams:l,rbxDurationSeconds:r,metadata:i}},e}(),oe=function(){function e(e){this.chunkState=new Map,this.videoElement=e}return e.prototype.downloadBuf=function(e){return T(this,void 0,void 0,function(){var t;return x(this,function(n){switch(n.label){case 0:return this.chunkState.set(e,"loading"),[4,fetch(e)];case 1:return[4,n.sent().blob()];case 2:return[4,n.sent().arrayBuffer()];case 3:return t=n.sent(),this.chunkState.set(e,"loaded"),[2,t]}})})},e.prototype.appendSegmentByIdx=function(e){return T(this,void 0,void 0,function(){var t,n,r,o,i,a,u=this;return x(this,function(s){switch(s.label){case 0:return null==(t=this.playlist)?[2]:t.segments[e]?(n=t.segmentUrl(e),this.chunkState.has(n)?[3,2]:[4,this.downloadBuf(n)]):[2];case 1:r=s.sent(),null===(i=this.sourceBuffer)||void 0===i||i.appendBuffer(r),e===(t.segments.length||0)-1&&(o=function(){var e,t;null===(e=u.sourceBuffer)||void 0===e||e.removeEventListener("updateend",o),null===(t=u.mediaSource)||void 0===t||t.endOfStream()},null===(a=this.sourceBuffer)||void 0===a||a.addEventListener("updateend",o)),s.label=2;case 2:return[2]}})})},e.prototype.open=function(e,t,n){return T(this,void 0,void 0,function(){var r,o,i,a,u=this;return x(this,function(s){switch(s.label){case 0:return r=new MediaSource,this.mediaSource=r,this.videoElement.src=URL.createObjectURL(r),[4,fetch(e.toString())];case 1:return[4,s.sent().text()];case 2:return o=s.sent(),i=re.parse(e,o),this.playlist=i,this.frameRate=n,[4,new Promise(function(e,n){var o=function(){try{var o=r.addSourceBuffer('video/webm; codecs="'.concat(t,'"'));e(o)}catch(e){n(e)}};"open"===r.readyState?(r.duration=i.duration(),o()):r.addEventListener("sourceopen",function(){r.duration=i.duration(),o()})})];case 3:return a=s.sent(),this.sourceBuffer=a,[4,this.appendSegmentByIdx(0)];case 4:return s.sent(),this.videoElement.ontimeupdate=function(){return T(u,void 0,void 0,function(){var e,t,n;return x(this,function(o){switch(o.label){case 0:return 0===r.sourceBuffers.length?[2]:(e=this.videoElement.currentTime,(t=H(a.buffered,e))&&Math.abs(t.end-e)<3?(n=i.nextSegmentIdx(e),[4,this.appendSegmentByIdx(n)]):[3,2]);case 1:o.sent(),o.label=2;case 2:return[2]}})})},this.videoElement.onseeking=function(){return T(u,void 0,void 0,function(){var e,t;return x(this,function(n){switch(n.label){case 0:return 0===r.sourceBuffers.length?[2]:(e=this.videoElement.currentTime,function(e,t){return null!=H(e,t)}(a.buffered,e)?[3,2]:(t=i.segmentIdxByTime(e),[4,this.appendSegmentByIdx(t)]));case 1:n.sent(),n.label=2;case 2:return[2]}})})},[2]}})})},e.fetchManifestData=function(e){return T(this,void 0,void 0,function(){var t,n,r,o,i,a,u,s,c;return x(this,function(l){switch(l.label){case 0:return[4,fetch(e,{method:"GET",credentials:"include"})];case 1:return[4,l.sent().text()];case 2:return t=l.sent(),n=JSON.parse(t),r=new URL(n.locations[0].location),[4,fetch(r.toString())];case 3:return[4,(o=l.sent()).text()];case 4:if(i=l.sent(),o.status<200||o.status>=400)throw new Error("ERROR: ".concat(o.status," ").concat(o.statusText,"\n").concat(i));if(!i.startsWith(Y))throw new Error("not an HLS manifest");return a=re.parseMasterManifest(i,r),u=re.selectHighestResStream(a.streams),""===(s=(s=u.get(G)||"").replace(/^"|"$/g,""))&&(s="vp9,opus"),c=u.get(J)||60,[2,{playlistUrl:r,manifestText:i,rbxDurationSeconds:a.rbxDurationSeconds,metadata:a.metadata,bestStream:u,codecs:s,frameRate:c}]}})})},e.prototype.openFromManifestData=function(e,t){return T(this,void 0,void 0,function(){return x(this,function(n){switch(n.label){case 0:return this.manifestMetadata=e.metadata,this.rbxDurationSeconds=e.rbxDurationSeconds,[4,this.open(new URL(e.bestStream.get(K),e.playlistUrl),e.codecs,e.frameRate)];case 1:return n.sent(),t&&t(this),[2]}})})},e.prototype.openMasterManifestURL=function(t,n){return T(this,void 0,void 0,function(){var r;return x(this,function(o){switch(o.label){case 0:return[4,e.fetchManifestData(t)];case 1:return r=o.sent(),[4,this.openFromManifestData(r,n)];case 2:return o.sent(),[2]}})})},e.prototype.frameVisitOffset=function(){return.5/(this.frameRate||.001)},e.prototype.cleanup=function(){try{this.mediaSource&&"open"===this.mediaSource.readyState&&this.mediaSource.endOfStream()}catch(e){}this.sourceBuffer=void 0,this.mediaSource=void 0,this.playlist=void 0,this.chunkState.clear(),this.videoElement&&(this.videoElement.ontimeupdate=null,this.videoElement.onseeking=null)},e.getRbxDurationFromManifestData=function(e){return e.rbxDurationSeconds},e.prototype.getRbxDuration=function(){return this.rbxDurationSeconds},e.prototype.getManifestMetadata=function(){return this.manifestMetadata},e.fetchManifestDataFromAssetId=function(t,n){return T(this,void 0,void 0,function(){var r,o;return x(this,function(i){return r=encodeURIComponent(btoa('[{"format":"hls","majorVersion":"1","fidelity":"main"}]')),o="production"===n?"https://assetdelivery.roblox.com/v2/asset?Id=".concat(t,"&&ContentRepresentationPriorityList=").concat(r):"https://assetdelivery.".concat(n,".robloxlabs.com/v2/asset?Id=").concat(t,"&&ContentRepresentationPriorityList=").concat(r),[2,e.fetchManifestData(o)]})})},e}();function ie(e){var r=this,o=e.videoAssetId,a=e.environment,u=e.enabled,s=void 0===u||u,c=t(void 0),l=c[0],d=c[1],f=t(!1),v=f[0],p=f[1],m=t(null),h=m[0],g=m[1],b=i(function(){return T(r,void 0,void 0,function(){var e,t;return x(this,function(n){switch(n.label){case 0:if(!s||!o||!a)return[2];n.label=1;case 1:return n.trys.push([1,3,4,5]),p(!0),g(null),[4,oe.fetchManifestDataFromAssetId(o,a)];case 2:return e=n.sent(),d(e),[3,5];case 3:return t=n.sent(),g(t),d(void 0),[3,5];case 4:return p(!1),[7];case 5:return[2]}})})},[o,a,s]),y=null==l?void 0:l.rbxDurationSeconds;return n(function(){b()},[b]),{manifest:l,durationInSeconds:y,loading:v,error:h,refetch:i(function(){b()},[b])}}function ae(){var e=[];try{if("undefined"!=typeof window){var t=window.navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(t)&&("ManagedMediaSource"in window||e.push("Safari 16 or older is not supported")),window.MediaSource){MediaSource.isTypeSupported('video/webm; codecs="vp9,opus"')||e.push("WebM VP9/Opus codec is not supported in this browser")}else e.push("MediaSource API is not supported in this browser")}}catch(t){e.push("Browser compatibility check failed")}return{isSupported:0===e.length,errors:e}}var ue=s()(function(e){return{errorContainer:{position:"relative",backgroundColor:e.palette.content.static.dark,width:"100%",height:"100%"}}}),se=function(t,i){var a=t.manifest,u=t.videoAssetId,s=t.environment,c=t.debug,l=void 0!==c&&c,d=t.analyticsConfig,f=t.enableAnalytics,v=t.onHoverActive,p=void 0!==v&&v,m=t.loop,h=void 0!==m&&m,g=t.fullscreenActive,b=void 0!==g&&g,y=t.onLoadVideoStart,E=t.onLoadVideoEnd,A=t.onLoadError,L=w(t,["manifest","videoAssetId","environment","debug","analyticsConfig","enableAnalytics","onHoverActive","loop","fullscreenActive","onLoadVideoStart","onLoadVideoEnd","onLoadError"]),P=F(i),M=ue(),C=M.classes,I=M.cx,V=o(void 0),k=r(function(){return ae()},[]),O=ie({videoAssetId:u,environment:s,enabled:!a&&k.isSupported}),D=a||O.manifest;return n(function(){O.error&&A&&A(O.error)},[O.error,A]),n(function(){if(!k.isSupported&&A){var e=new Error("Browser not supported: ".concat(k.errors.join(", ")));A(e)}},[A,k.isSupported,k.errors]),n(function(){var e=P.current;if(null!=e&&void 0!==D&&k.isSupported&&!O.error){return T(void 0,void 0,void 0,function(){var t,n;return x(this,function(r){switch(r.label){case 0:if(!e||!D)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),null==y||y(),t=new oe(e),V.current=t,[4,t.openFromManifestData(D,function(){null==E||E()})];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),A&&n instanceof Error&&A(n),[3,4];case 4:return[2]}})}),function(){V.current&&(V.current.cleanup(),V.current=void 0)}}},[D,P,y,E,A,O.error,k.isSupported]),k.isSupported&&!O.error&&D?e.createElement(B,S({ref:P,debug:l,analyticsConfig:d,enableAnalytics:f,onHoverActive:p,loop:h,fullscreenActive:b},L)):e.createElement("div",{className:I(L.className,C.errorContainer)})};se.displayName="RobloxVideoPlayer";var ce=e.forwardRef(se),le=function(e){var t=Math.floor(e/60),n=Math.floor(e%60);return"".concat(t,":").concat(n.toString().padStart(2,"0"))};export{ce as RobloxVideoPlayer,B as VideoPlayer,oe as WebmHlsPlayer,le as formatDuration,ae as isVideoPlayerSupportedByBrowser,ie as useVideoManifest};
